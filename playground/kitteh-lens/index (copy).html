<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />

	<title>Pixel scripts</title>
</head>

<body>
	<canvas id="canvas" width="800" height="600"></canvas>
	<img id="img" src="kittez.jpg" style="display:none;" />

	<script type="text/javascript">
	/* <![CDATA[ */
	var
		canvas = document.getElementById('canvas'),
		img = document.getElementById('img'),
		lens = new Lens(400, 100, 150);

	if(!canvas.getContext) {
		throw "Canvas ain't got no context";
	}

	function render() {
		var ctx = canvas.getContext('2d');
		ctx.drawImage(img, 0, 0);

		var canvasData = ctx.getImageData(0, 0, canvas.width, canvas.height);

		for (var x = 0; x < canvasData.width; x++) {
			for (var y = 0; y < canvasData.height; y++) {
				var r, g, b;
				var p = lens.computeRefraction(x, y);
				var iTarget = (x + y * canvas.width) * 4;

				/*
				if(p[0] < 0 || p[1] < 0 || p[0] > canvas.width || p[1] > canvas.height) {
					r = g = b = 0xff;
				} else {
				*/
					var iSrc = (p[0] + p[1] * canvas.width) * 4,

					r = canvasData.data[iSrc + 0];
					g = canvasData.data[iSrc + 1];
					b = canvasData.data[iSrc + 2];
				//}

				canvasData.data[iTarget + 0] = r;
				canvasData.data[iTarget + 1] = g;
				canvasData.data[iTarget + 2] = b;
			}
		}

		ctx.putImageData(canvasData, 0, 0);
	}


	img.onload = render;


	canvas.onmousemove = function(e) {
		lens.centerX = e.pageX;
		lens.centerY = e.pageY;

		render();
	};


	function Lens(cx, cy, radius, concave) {
		this.centerX = cx;
		this.centerY = cy;
		this.radius = radius;
		this.concave = concave === true;

		/*
			Given a point (x, y) the function will return a point [a, b]
			with the coordinates to get the color from.
		*/
		this.computeRefraction = function(x, y) {
			var
				dx = x - this.centerX,
				dy = y - this.centerY,
				dist = dx * dx + dy * dy,
				r2 = this.radius * this.radius;

			//The point is not inside the circle, so take the color at that point
			if(dist > r2) {
				return [x, y];
			}

			var
				relativeDist = 1 - dist / r2,
				a, b;


			if(x !== this.centerX) {
				a = x + (this.centerX - x) * relativeDist;
			} else if (x > this.centerX) {
				a = x - (x - this.centerX) * (1 - relativeDist);
			} else {
				a = x;
			}


			if(y !== this.centerY) {
				b = y + (this.centerY - y) * relativeDist;
			} else if (y > this.centerY) {
				b = y + (y - this.centerY) * (1 - relativeDist);
			} else {
				b = y;
			}

			return [a  | 0, b | 0];
		}
	}
	/* ]]> */
	</script>
</body>

</html>
